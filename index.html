<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Schedule</title>
  <meta name="color-scheme" content="light only" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --row-h: 64px; }

    html,body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; }

    .scrollbar::-webkit-scrollbar{ width:8px; height:8px; }
    .scrollbar::-webkit-scrollbar-track{ background:#f1f1f1;}
    .scrollbar::-webkit-scrollbar-thumb{ background:#a8a8a8; border-radius:4px;}
    .scrollbar::-webkit-scrollbar-thumb:hover{ background:#888; }

    .tab-btn.active{ border-bottom-color:#3b82f6; color:#111827; font-weight:600; }
    .day-col { position: relative; }

    /* ===== Event cards ===== */
    .event-card{
      position:absolute; box-sizing:border-box;
      border-left-width:4px; border-radius:0.5rem;
      padding:0.5rem 0.75rem; z-index:10;
      overflow:hidden;                         /* no spill below card */
      font-size:.8125rem;
      cursor:pointer; user-select:none;
      pointer-events:auto;
    }
    /* single-line truncation + tight line-height for every row */
    .event-line{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .event-tight{ line-height:1; }

    .event-card .title{ font-weight:700; font-size:.825rem; text-transform:uppercase; }
    .event-card .subtext{ font-size:.7rem; opacity:.9; }
    .event-card .location{ font-size:.7rem; opacity:.75; }
    .event-card.narrow .title{ font-size:.8rem; }

    .now-line{ position:absolute; height:2px; background:#ef4444; z-index:30; }
    .now-dot{ position:absolute; width:8px; height:8px; background:#ef4444; border-radius:9999px; left:0; top:50%; transform:translate(-50%,-50%); }

    .tz-hide{ display:none !important; }

    /* Primary segmented control */
    .seg{ display:inline-flex; border:1px solid #e5e7eb; border-radius:9999px; padding:2px; background:#fff; }
    .seg button{ padding:.375rem .875rem; border-radius:9999px; font-weight:600; color:#374151; }
    .seg button[aria-pressed="true"]{ background:#111827; color:#fff; }

    /* ===== popup (always on top) ===== */
    .popup-backdrop{
      position:fixed; inset:0; background:transparent; z-index:9998;
    }
    .popup{
      position:absolute; z-index:9999;
      min-width:240px; max-width:320px;
      background:#fff; border:1px solid #e5e7eb; border-radius:0.75rem;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
      padding:.75rem .9rem;
    }

    /* Responsive tweaks */
    @media (max-width: 768px){
      .event-card{ padding:.25rem .5rem; font-size:.75rem; }
      .event-card .title{ font-size:.8125rem; }
    }
    @media (max-width: 640px){
      .event-card{ padding:.125rem .25rem; font-size:.6875rem; }
      .event-card .title{ font-size:.75rem; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <main class="mx-auto max-w-none p-4 px-6">

    <!-- Controls -->
    <div class="no-print grid grid-cols-3 items-center gap-3 mb-3">
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100" aria-label="Previous week">◀</button>
        <button id="todayBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100">Today</button>
        <button id="nextBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100" aria-label="Next week">▶</button>
      </div>
      <div id="rangeLabel" class="font-semibold text-center text-xl"></div>
      <div class="text-sm text-gray-500 tz-hide">Times shown in <span id="tzLabel"></span></div>
    </div>

    <!-- PRIMARY tabs -->
    <div class="mb-3 flex items-center justify-between flex-wrap gap-3">
      <div id="primaryTabs" class="seg" role="tablist" aria-label="Primary calendars"></div>
    </div>

    <!-- SUB tabs -->
    <div class="mb-4 border-b border-gray-200">
      <nav id="tabs" class="-mb-px flex flex-wrap gap-6" aria-label="Sub-calendars"></nav>
    </div>

    <!-- Desktop grid -->
    <section class="hidden md:block bg-white rounded-lg shadow overflow-hidden">
      <div id="gridScroller" class="scrollbar overflow-auto" style="height: 80vh;">
        <div class="relative">
          <div id="gridHeader" class="grid sticky top-0 bg-white z-20 shadow-sm"
               style="grid-template-columns: 4rem repeat(7, minmax(160px, 1fr));"></div>
          <div id="gridBody" class="grid relative"
               style="grid-template-columns: 4rem repeat(7, minmax(160px, 1fr));"></div>
        </div>
      </div>
    </section>

    <!-- Mobile list -->
    <section id="listView" class="md:hidden bg-white rounded-lg shadow p-4 space-y-5 overflow-y-auto" style="height: 80vh;"></section>
  </main>

  <script>
  /* =================== Config & Colors =================== */
  // const CSV_PATH = new URLSearchParams(location.search).get('csv') ||
  // 'https://recscheduler.blob.core.windows.net/csv-daily-transfer/schedule/FR.csv';

  const CSV_PATH = 'FR.csv'; // local file but actual format - just had to fix comma delimited activity names screwing up the parser
  const GMCC = 'Greater Midland Community Center';

  /** Colors */
  const PALETTE = {
    red:["bg-red-100","text-red-800","border-red-500"],
    orange:["bg-orange-100","text-orange-800","border-orange-500"],
    yellow:["bg-yellow-100","text-yellow-800","border-yellow-500"],
    green:["bg-green-100","text-green-800","border-green-500"],
    teal:["bg-teal-100","text-teal-800","border-teal-500"],
    cyan:["bg-cyan-100","text-cyan-800","border-cyan-500"],
    blue:["bg-blue-100","text-blue-800","border-blue-500"],
    purple:["bg-purple-100","text-purple-800","border-purple-500"],
    indigo:["bg-indigo-100","text-indigo-800","border-indigo-500"],
    pink:["bg-pink-100","text-pink-800","border-pink-500"],
    gray:["bg-gray-200","text-gray-800","border-gray-500"],
  };

  /*
  balanced in motion
  barre
  body blast
  body sculpt
  bootcamp
  butts and gutts
  chair yoga
  circuit
  cycle
  cycle fusion
  functional fitness
  piyo
  power up
  seniors in motion
  shine dance fitness
  silversneakers classic
  silversneakers yoga
  strictly strength
  trx
  yoga
  zumba
  boxing fitness
  circuit express
  intro to kettlebells
  rise and shine bootcamp
  */

  const ACTIVITY_COLORS = {
    'LAP SWIM':'blue','REC SWIM':'green',
    'BASKETBALL':'orange','VOLLEYBALL':'yellow','PICKLEBALL':'red',
    'MAH JONGG':'pink','EUCHRE':'cyan','LINE DANCING':'purple',

    'AQUA CIRCUIT':'blue','AQUA FIT':'teal','AQUA FIT BLAST':'indigo','AQUA BARRE':'purple',
    'AQUA ARTHRITIS':'cyan','SILVERSNEAKERS SPLASH':'green','AQUA ZUMBA':'pink','BALANCE AND CORE':'yellow',

    'BALANCED IN MOTION':'blue','BARRE':'purple','BODY BLAST':'red','BODY SCULPT':'orange',
    'BOOTCAMP':'cyan','BUTTS AND GUTS':'blue','CHAIR YOGA':'yellow','CIRCUIT':'green',
    'CYCLE':'green','CYCLE FUSION':'teal','FUNCTIONAL FITNESS':'indigo','PIYO':'indigo',
    'POWER UP':'cyan','SENIORS IN MOTION':'yellow','SHINE':'cyan',
    'SILVERSNEAKERS CLASSIC':'orange','STRICTLY STRENGTH':'yellow','TRX':'teal',
    'YOGA':'indigo','ZUMBA':'pink','BOXING FITNESS':'yellow','CIRCUIT EXPRESS':'green',
    'INTRO TO KETTLEBELLS':'red','RISE AND SHINE BOOTCAMP':'pink','ROCK STEADY BOXING':'orange',

    'DEFAULT':'gray'
  };

  const getColorForActivity = (name) => {
    const upper = String(name).toUpperCase();
    for (const [k,c] of Object.entries(ACTIVITY_COLORS)) if (upper.includes(k)) return c;
    return ACTIVITY_COLORS.DEFAULT;
  };

  /* =================== Model & Tabs =================== */
  let ALL_EVENTS = {};
  let CURRENT_WEEK = {};

  const PRIMARY = {
    dropin:  { label:'Drop-In',      subs:{ aquatics:'Aquatics', courtSports:'Court Sports', community:'Community' } },
    fitness: { label:'Group Fitness', subs:{ aquatics:'Aquatics', studio1:'Studio 1', studio2:'Studio 2', mac:'MAC Gym' } }
  };

  /* =================== Helpers =================== */
  function parseTime12h(t){
    const [time, apRaw='AM'] = String(t).trim().split(' ');
    const [hh, mm='0'] = time.split(':').map(Number);
    let h = hh % 12; if (apRaw.toUpperCase()==='PM') h += 12;
    return h + (+mm/60);
  }

  function parseDateFlexible(s){
    const x=String(s).trim();
    if (x.includes('/')){ const [mm,dd,yyyy]=x.split('/').map(Number); return new Date(yyyy,mm-1,dd); }
    if (x.includes('-')){ const [yyyy,mm,dd]=x.split('-').map(Number); return new Date(yyyy,mm-1,dd); }
    return new Date(x);
  }

  function cleanLocation(loc){
    if (!loc) return '';
    return String(loc).replace(/\s*\(\s*\d+\s*\)\s*$/,'').trim(); // remove codes: " (2020)"
  }

  function fitnessSubFromLocation(loc){
    const L=cleanLocation(loc).toLowerCase();
    if (L.includes('pool') || L.includes('lap')) return 'aquatics';
    if (L === 'studio 1') return 'studio1';
    if (L === 'studio 2') return 'studio2';
    if (L.includes('mac gym') || L === 'mac') return 'mac';
    return null;
  }

  function classifyDropIn(activity, location){
    const A=String(activity).toUpperCase(), L=cleanLocation(location).toUpperCase();
    if (A.includes('SWIM') || L.includes('POOL') || L.includes('LAP')) return 'aquatics';
    if (['BASKETBALL','VOLLEYBALL','PICKLEBALL'].some(k=>A.includes(k)) || L.includes('COURT')) return 'courtSports';
    return 'community';
  }

  function ev(name, location, dayIndex, start, end, colorKey, type='dropin', sub='aquatics'){
    const [bg,text,border] = PALETTE[colorKey];
    return { id:`${name}-${dayIndex}-${start}`, name, location, dayIndex, start, end,
             color:{bg,text,border}, type, sub, date:null };
  }

  function eqGMCC(s){ return String(s||'').trim().toLowerCase() === GMCC.toLowerCase(); }

  /* =================== RecTrac CSV Parser =================== */
  async function loadCSVData(){
    try{
      const csvText = await fetch(CSV_PATH, {cache:'no-store'}).then(r=>r.text());
      return parseCSV(csvText);
    }catch(err){
      console.error('CSV load failed:', err);
      // empty scaffolding so UI renders
      return {
        dropin:{ aquatics:{label:'Aquatics',events:[]}, courtSports:{label:'Court Sports',events:[]}, community:{label:'Community',events:[]} },
        fitness:{ aquatics:{label:'Aquatics',events:[]}, studio1:{label:'Studio 1',events:[]}, studio2:{label:'Studio 2',events:[]}, mac:{label:'MAC Gym',events:[]} }
      };
    }
  }

  function parseCSV(csvText){
    const rows = csvText.replace(/\r/g,'').trim().split('\n');
    // Assume first row is a header from RecTrac
    const lines = rows.slice(1);

    const store = {
      dropin:{ aquatics:{label:'Aquatics',events:[]}, courtSports:{label:'Court Sports',events:[]}, community:{label:'Community',events:[]} },
      fitness:{ aquatics:{label:'Aquatics',events:[]}, studio1:{label:'Studio 1',events:[]}, studio2:{label:'Studio 2',events:[]}, mac:{label:'MAC Gym',events:[]} }
    };

    for (const raw of lines){
      if (!raw.trim()) continue;
      const parts = raw.split(',').map(s=>s.trim());
      if (parts.length < 9) continue;

      const facility = parts[0];
      const locationRaw = parts[1];
      const dateStr = parts[3];
      const startTime = parts[4];
      const endTime = parts[5];
      const activity = parts[6];
      const building = parts[7];
      const reserver = parts[8];

      // Filters per your rules
      if (!eqGMCC(facility)) continue;
      if (!(eqGMCC(building) && eqGMCC(reserver))) continue;

      const location = cleanLocation(locationRaw);
      const startHour = parseTime12h(startTime);
      const endHour   = parseTime12h(endTime);
      const eventDate = parseDateFlexible(dateStr);
      if (isNaN(+eventDate)) continue;

      const jsDay = eventDate.getDay();
      const dayIndex = (jsDay + 6) % 7;

      let type='dropin', sub='community';
      const maybeFitness = fitnessSubFromLocation(location);
      if (maybeFitness){
        type='fitness'; sub=maybeFitness;
      } else {
        sub = classifyDropIn(activity, location);
      }

      const colorKey = getColorForActivity(activity);
      const e = ev(activity, location, dayIndex, startHour, endHour, colorKey, type, sub);
      e.date = eventDate;
      store[type][sub].events.push(e);
    }

    return store;
  }

  /* =================== Week helpers =================== */
  function getMonday(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function labelDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }
  function formatTime(hour){
    const h=Math.floor(hour), m=Math.round((hour-h)*60);
    const h12=(h%12)||12, ap=h<12?'AM':'PM', mm=m===0?'00':String(m).padStart(2,'0');
    return `${h12}:${mm} ${ap}`;
  }

  function filterWeek(all, weekStart){
    const weekEnd = addDays(weekStart,6);
    const out = {
      dropin:{ aquatics:{label:'Aquatics',events:[]}, courtSports:{label:'Court Sports',events:[]}, community:{label:'Community',events:[]} },
      fitness:{ aquatics:{label:'Aquatics',events:[]}, studio1:{label:'Studio 1',events:[]}, studio2:{label:'Studio 2',events:[]}, mac:{label:'MAC Gym',events:[]} }
    };
    for (const type of Object.keys(all)){
      for (const sub of Object.keys(all[type])){
        for (const e of all[type][sub].events){
          if (e.date >= weekStart && e.date <= weekEnd){
            const daysDiff = Math.floor((e.date - weekStart)/(1000*60*60*24));
            out[type][sub].events.push({...e, dayIndex:daysDiff});
          }
        }
      }
    }
    return out;
  }

  /* =================== State & refs =================== */
  const params = new URLSearchParams(location.search);
  const START_OF_WEEK = getMonday(new Date());
  let weekStart = params.get('w') ? new Date(params.get('w')) : START_OF_WEEK;
  if (isNaN(+weekStart)) weekStart = START_OF_WEEK;

  let currentType = (['dropin','fitness'].includes(params.get('type')) ? params.get('type') : 'dropin');
  let currentSub  = params.get('sub') || 'aquatics';

  const els = {
    primaryTabs: document.getElementById('primaryTabs'),
    tabs: document.getElementById('tabs'),
    gridHeader: document.getElementById('gridHeader'),
    gridBody: document.getElementById('gridBody'),
    list: document.getElementById('listView'),
    rangeLabel: document.getElementById('rangeLabel'),
    tzLabel: document.getElementById('tzLabel'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    todayBtn: document.getElementById('todayBtn'),
    scroller: document.getElementById('gridScroller'),
  };
  els.tzLabel.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;

  let dayOverlays=[];

  /* ===== popup state & functions ===== */
  let openpopupNodes = []; // [backdrop, popup]

  function closepopup(){
    openpopupNodes.forEach(n => n.remove());
    openpopupNodes = [];
    window.removeEventListener('keydown', escListener);
  }
  function escListener(e){ if (e.key === 'Escape') closepopup(); }

  function openpopup(eventObj, cardEl){
    closepopup();

    const backdrop = document.createElement('div');
    backdrop.className = 'popup-backdrop';
    backdrop.addEventListener('click', closepopup);

    const pop = document.createElement('div');
    pop.className = 'popup';

    const minutes = Math.round((eventObj.end - eventObj.start) * 60);
    const titleColorClass = eventObj?.color?.text || 'text-gray-900';

    pop.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <h3 class="text-lg font-bold tracking-wide ${titleColorClass}">
          ${eventObj.name}
        </h3>
      </div>
      <div class="mt-1 text-sm text-gray-700">
        ${formatTime(eventObj.start)} – ${formatTime(eventObj.end)} (${minutes} min)
      </div>
      ${eventObj.location ? `<div class="text-sm text-gray-500">${eventObj.location}</div>` : ''}
      <div class="mt-2 text-xs text-gray-400">Click outside to close</div>
    `;

    // Position beside the card; clamp to grid viewport
    const gridRect = els.gridBody.getBoundingClientRect();
    const cardRect = cardEl.getBoundingClientRect();
    const POP_W = 300, GAP = 12;

    const showRight = cardRect.right + GAP + POP_W < window.innerWidth;
    let left = showRight
      ? (cardRect.right - gridRect.left + GAP)
      : (cardRect.left  - gridRect.left - GAP - POP_W);
    left = Math.max(8, Math.min(left, gridRect.width - POP_W - 8));

    let top = cardRect.top - gridRect.top;
    top = Math.max(8, Math.min(top, gridRect.height - 16));

    pop.style.left = `${left}px`;
    pop.style.top  = `${top}px`;

    document.body.appendChild(backdrop);   // z-index 9998
    els.gridBody.appendChild(pop);         // z-index 9999
    openpopupNodes = [backdrop, pop];
    window.addEventListener('keydown', escListener);
  }

  /* =================== Controls =================== */
  els.prevBtn.onclick = () => changeWeek(-7);
  els.nextBtn.onclick = () => changeWeek(+7);
  els.todayBtn.onclick = () => { weekStart=getMonday(new Date()); CURRENT_WEEK=filterWeek(ALL_EVENTS, weekStart); syncUrl(); render(); };

  function changeWeek(delta){ weekStart=addDays(weekStart,delta); CURRENT_WEEK=filterWeek(ALL_EVENTS, weekStart); syncUrl(); render(); }
  function syncUrl(){ const p=new URLSearchParams(); p.set('type',currentType); p.set('sub',currentSub); p.set('w',ymd(weekStart)); history.replaceState(null,'',`?${p.toString()}`); }

  /* =================== Rendering =================== */
  function renderPrimary(){
    els.primaryTabs.innerHTML='';
    for (const type of Object.keys(PRIMARY)){
      const btn=document.createElement('button');
      btn.type='button'; btn.setAttribute('role','tab');
      btn.setAttribute('aria-pressed', String(type===currentType));
      btn.className='focus:outline-none';
      btn.textContent=PRIMARY[type].label;
      btn.onclick=()=>{
        currentType=type;
        if (!PRIMARY[currentType].subs[currentSub]) currentSub=Object.keys(PRIMARY[currentType].subs)[0];
        syncUrl(); render();
      };
      els.primaryTabs.appendChild(btn);
    }
  }

  function renderSubTabs(){
    els.tabs.innerHTML='';
    const subs=PRIMARY[currentType].subs;
    for (const key of Object.keys(subs)){
      const btn=document.createElement('button');
      btn.className='tab-btn py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300';
      btn.textContent=subs[key];
      if (key===currentSub) btn.classList.add('active');
      btn.onclick=()=>{ currentSub=key; document.querySelectorAll('#tabs .tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); syncUrl(); renderBody(); };
      els.tabs.appendChild(btn);
    }
  }

  function render(){ closepopup(); renderPrimary(); renderSubTabs(); renderHeader(); renderBody(); }

  function renderHeader(){
    els.gridHeader.innerHTML='';
    const timeCell=document.createElement('div');
    timeCell.className='p-2 border-r border-b border-gray-200 text-xs text-center font-semibold text-gray-500 flex items-center justify-center';
    timeCell.textContent='EDT';
    els.gridHeader.appendChild(timeCell);

    for (let i=0;i<7;i++){
      const d=addDays(weekStart,i);
      const h=document.createElement('div');
      h.className='p-2 border-b border-gray-200 text-center';
      const isToday=ymd(d)===ymd(new Date());
      h.innerHTML=`<p class="text-sm font-semibold ${isToday?'text-blue-600':'text-gray-600'}">${['MON','TUE','WED','THU','FRI','SAT','SUN'][i]}</p>
                   <p class="text-xs ${isToday?'font-semibold text-blue-600':'text-gray-700'}">${labelDate(d)}</p>`;
      els.gridHeader.appendChild(h);
    }
    const end=addDays(weekStart,6);
    els.rangeLabel.textContent=`${labelDate(weekStart)} – ${labelDate(end)}`;
  }

  function renderBody(){ renderGrid(); renderList(); }

  function renderGrid(){
    closepopup(); // ensure previous popups are gone
    const startHour=5, endHour=22;
    const rowH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
    els.gridBody.innerHTML=''; dayOverlays=[];

    for (let hour=startHour; hour<=endHour; hour++){
      const t=document.createElement('div');
      t.className='p-2 border-r border-gray-200 text-right text-xs text-gray-400 h-16 flex items-start justify-end -mt-2.5';
      if (hour<endHour){ const h12=(hour%12)||12; t.textContent=`${h12} ${hour<12?'AM':'PM'}`; }
      els.gridBody.appendChild(t);
      for (let day=0; day<7; day++){
        const cell=document.createElement('div');
        cell.className='border-r border-b border-gray-200 h-16 day-col';
        cell.dataset.day=day;
        els.gridBody.appendChild(cell);
      }
    }

    // overlays per day
    const firstRow=[...els.gridBody.querySelectorAll('.day-col')].slice(0,7);
    const totalH=(endHour-startHour)*rowH;
    for (let day=0; day<7; day++){
      const ref=firstRow[day];
      const left=ref.offsetLeft + ref.clientLeft;
      const width=ref.clientWidth;
      const ov=document.createElement('div');
      ov.style.position='absolute'; ov.style.zIndex='5'; ov.style.top='0';
      ov.style.left=`${left}px`; ov.style.width=`${width}px`; ov.style.height=`${totalH}px`; ov.style.pointerEvents='none';
      els.gridBody.appendChild(ov);
      dayOverlays[day]=ov;
    }

    const events=CURRENT_WEEK[currentType][currentSub].events;
    const byDay=Array.from({length:7},()=>[]);
    events.forEach(e=>byDay[e.dayIndex].push(e));

    for (let day=0; day<7; day++){
      const list=byDay[day].slice().sort((a,b)=> a.start===b.start ? b.end-a.end : a.start-b.start);
      placeEventsInDay(day, list);
    }

    positionNowLine(startHour,endHour);
  }

  function placeEventsInDay(dayIndex, dayEvents){
    if (!dayEvents.length) return;
    const startHour=5;
    const rowH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
    const groups=findOverlappingGroups(dayEvents);

    groups.forEach(group=>{
      const n=group.length;
      group.forEach((e,i)=>{
        const top=(e.start-startHour)*rowH;
        const height=(e.end-e.start)*rowH;

        const card=document.createElement('div');
        card.className=`event-card shadow-sm ${e.color.bg} ${e.color.text} ${e.color.border}`;
        card.style.top=`${top}px`; card.style.height=`${height}px`;

        if (n>1){
          const GAP=8;
          const width=`calc((100% - ${(n-1)*GAP}px) / ${n})`;
          const left=`calc(${i} * ( (100% - ${(n-1)*GAP}px) / ${n} + ${GAP}px))`;
          card.style.width=width; card.style.left=left; card.classList.add('narrow');
        } else {
          const PAD=8;
          card.style.width=`calc(100% - ${PAD*2}px)`; card.style.left=`${PAD}px`;
        }

        // Title (Title Case)
        const name=e.name.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(' ');

        // <= 30 min → time + location on one line; else location on new line
        const duration = e.end - e.start;
        let timeAndLoc;
        if (duration <= 0.5 && e.location){
          timeAndLoc = `<p class="event-line event-tight subtext">${formatTime(e.start)} – ${formatTime(e.end)}, ${e.location}</p>`;
        } else {
          timeAndLoc = `<p class="event-line event-tight subtext">${formatTime(e.start)} – ${formatTime(e.end)}</p>` +
                       (e.location ? `<p class="event-line event-tight location">${e.location}</p>` : '');
        }

        // Slightly tighter layout for very short cards
        if (height <= 40){ card.style.padding = '.35rem .5rem'; card.style.fontSize = '.76rem'; }

        card.innerHTML = `
          <p class="event-line event-tight title">${name}</p>
          ${timeAndLoc}
        `;

        // Click -> popup
        card.addEventListener('click', (ev) => { ev.stopPropagation(); openpopup(e, card); });

        const ov=dayOverlays[dayIndex]; if (ov) ov.appendChild(card);
      });
    });
  }

  function findOverlappingGroups(events){
    if (!events.length) return [];
    const sorted=[...events].sort((a,b)=> a.start-b.start);
    const groups=[]; let curr=[]; let maxEnd=-Infinity;
    for (const e of sorted){
      if (!curr.length || e.start < maxEnd){ curr.push(e); maxEnd=Math.max(maxEnd, e.end); }
      else { groups.push(curr); curr=[e]; maxEnd=e.end; }
    }
    if (curr.length) groups.push(curr);
    return groups;
  }

  function positionNowLine(startHour,endHour){
    document.querySelectorAll('.now-line').forEach(n=>n.remove());
    const now=new Date(); const dow=(now.getDay()+6)%7; const h=now.getHours(), m=now.getMinutes();
    if (h<startHour || h>=endHour) return;
    const ov=dayOverlays[dow]; if (!ov) return;
    const rowH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
    const top=((h-startHour)*60 + m) * (rowH/60);
    const line=document.createElement('div'); line.className='now-line'; line.style.left='0'; line.style.right='0'; line.style.top=`${top}px`;
    const dot=document.createElement('div'); dot.className='now-dot';
    line.appendChild(dot); ov.appendChild(line);
  }

  // Mobile list
  function renderList(){
    els.list.innerHTML='';
    const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const events=CURRENT_WEEK[currentType][currentSub].events;
    const byDay=Array.from({length:7},()=>[]);
    events.forEach(e=>byDay[e.dayIndex].push(e));
    for (let i=0;i<7;i++){
      const d=addDays(weekStart,i);
      const header=document.createElement('div');
      const isToday=ymd(d)===ymd(new Date());
      header.className='pt-2 pb-2 border-b';
      header.innerHTML=`<h2 class="text-lg font-bold ${isToday?'text-blue-700':''}">${days[i]}</h2><div class="text-xs text-gray-500">${labelDate(d)}</div>`;
      els.list.appendChild(header);
      if (!byDay[i].length){
        const none=document.createElement('div'); none.className='text-sm text-gray-400 pt-2'; none.textContent='No events'; els.list.appendChild(none);
      }else{
        byDay[i].sort((a,b)=>a.start-b.start).forEach(e=>{
          const item=document.createElement('div');
          item.className=`mt-2 p-3 rounded-lg ${e.color.bg} ${e.color.text}`;
          item.innerHTML=`<p class="font-semibold">${e.name}</p>
                          <p class="text-sm opacity-90">${formatTime(e.start)} – ${formatTime(e.end)}</p>
                          ${e.location?`<p class="text-sm opacity-75">${e.location}</p>`:''}`;
          els.list.appendChild(item);
        });
      }
    }
  }

  // Resize: reflow
  let resizeTimeout;
  window.addEventListener('resize', ()=>{ clearTimeout(resizeTimeout); resizeTimeout=setTimeout(()=>renderGrid(),100); });

  /* =================== Boot =================== */
  async function initialize(){
    ALL_EVENTS = await loadCSVData();
    CURRENT_WEEK = filterWeek(ALL_EVENTS, weekStart);

    // ensure current sub is valid for selected type
    if (!PRIMARY[currentType].subs[currentSub]) currentSub = Object.keys(PRIMARY[currentType].subs)[0];

    render(); syncUrl();
  }
  initialize();
  </script>
</body>
</html>
