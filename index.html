<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Schedule</title>
  <meta name="color-scheme" content="light only" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --row-h: 64px; }
    html,body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .scrollbar::-webkit-scrollbar{ width:8px; height:8px; }
    .scrollbar::-webkit-scrollbar-track{ background:#f1f1f1;}
    .scrollbar::-webkit-scrollbar-thumb{ background:#a8a8a8; border-radius:4px;}
    .scrollbar::-webkit-scrollbar-thumb:hover{ background:#888; }

    .tab-btn.active{ border-bottom-color:#3b82f6; color:#111827; font-weight:600; }
    .day-col { position: relative; }

    /* Event cards */
    .event-card{
      position:absolute; box-sizing:border-box;
      border-left-width:4px; border-radius:0.5rem;
      padding:0.5rem 0.75rem; z-index:10; overflow:hidden;
      font-size:.8125rem; cursor:pointer; user-select:none; pointer-events:auto;
    }
    .event-line{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .event-tight{ line-height:1; }
    .event-card .title{ font-weight:700; font-size:.825rem; text-transform:uppercase; }
    .event-card .subtext{ font-size:.7rem; opacity:.9; }
    .event-card .location{ font-size:.7rem; opacity:.75; }
    .event-card.narrow .title{ font-size:.8rem; }

    .now-line{ position:absolute; height:2px; background:#ef4444; z-index:30; }
    .now-dot{ position:absolute; width:8px; height:8px; background:#ef4444; border-radius:9999px; left:0; top:50%; transform:translate(-50%,-50%); }

    .seg{ display:inline-flex; border:1px solid #e5e7eb; border-radius:9999px; padding:2px; background:#fff; }
    .seg button{ padding:.375rem .875rem; border-radius:9999px; font-weight:600; color:#374151; }
    .seg button[aria-pressed="true"]{ background:#111827; color:#fff; }

    .popup-backdrop{ position:fixed; inset:0; background:transparent; z-index:9998; }
    .popup{
      position:absolute; z-index:9999; min-width:240px; max-width:320px;
      background:#fff; border:1px solid #e5e7eb; border-radius:0.75rem;
      box-shadow:0 10px 30px rgba(0,0,0,.15); padding:.75rem .9rem;
    }

    @media (max-width: 768px){
      .event-card{ padding:.25rem .5rem; font-size:.75rem; }
      .event-card .title{ font-size:.8125rem; }
    }
    @media (max-width: 640px){
      .event-card{ padding:.125rem .25rem; font-size:.6875rem; }
      .event-card .title{ font-size:.75rem; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <main class="mx-auto max-w-none p-4 px-6">

    <!-- Controls -->
    <div class="no-print grid grid-cols-3 items-center gap-3 mb-3">
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100 text-gray-700" aria-label="Previous week">◀︎</button>
        <button id="todayBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100">Today</button>
        <button id="nextBtn" class="px-2 py-1 rounded border text-sm hover:bg-gray-100 text-gray-700" aria-label="Next week">▶︎</button>
      </div>
      <div id="rangeLabel" class="font-semibold text-center text-xl"></div>
      <div class="text-sm text-gray-500">Times shown in <span id="tzLabel"></span></div>
    </div>

    <!-- PRIMARY tabs -->
    <div class="mb-3 flex items-center justify-between flex-wrap gap-3">
      <div id="primaryTabs" class="seg" role="tablist" aria-label="Primary calendars"></div>
    </div>

    <!-- SUB tabs -->
    <div class="mb-4 border-b border-gray-200">
      <nav id="tabs" class="-mb-px flex flex-wrap gap-6" aria-label="Sub-calendars"></nav>
    </div>

    <!-- Desktop grid -->
    <section class="hidden md:block bg-white rounded-lg shadow overflow-hidden">
      <div id="gridScroller" class="scrollbar overflow-auto" style="height: 80vh;">
        <div class="relative">
          <div id="gridHeader" class="grid sticky top-0 bg-white z-20 shadow-sm"
               style="grid-template-columns: 4rem repeat(7, minmax(160px, 1fr));"></div>
          <div id="gridBody" class="grid relative"
               style="grid-template-columns: 4rem repeat(7, minmax(160px, 1fr));"></div>
        </div>
      </div>
    </section>

    <!-- Mobile list -->
    <section id="listView" class="md:hidden bg-white rounded-lg shadow p-4 space-y-5 overflow-y-auto" style="height: 80vh;"></section>
  </main>

  <script>
  /* =================== Config & Colors =================== */
  const CSV_URL = 'https://recscheduler.blob.core.windows.net/csv-daily-transfer/schedule/FR.csv';
  const GMCC = 'Greater Midland Community Center';

  // Location classification (exact per your rules)
  // match is performed on the location with the room code stripped
  const LOC_RULES = [
    { match: /^Court\s*1\s*Full\s*A\+B/i, type:'dropin',  sub:'courtSports', label:'Court 1' },
    { match: /^Court\s*2\s*Full\s*A\+B/i, type:'dropin',  sub:'courtSports', label:'Court 2' },
    { match: /^Court\s*3\s*MAC\s*Gym/i,  type:'fitness', sub:'mac',         label:'MAC Gym' },
    { match: /^Studio\s*1/i,             type:'fitness', sub:'studio1',     label:'Studio 1' },
    { match: /^Studio\s*2/i,             type:'fitness', sub:'studio2',     label:'Studio 2' },
    { match: /^Multi-?use\s*Pool\s*1/i,  type:'fitness', sub:'aquatics',    label:'Multi-use Pool 1' },
    { match: /^Multi-?use\s*Pool\s*2/i,  type:'fitness', sub:'aquatics',    label:'Multi-use Pool 2' },
    { match: /^Multi-?use\s*Pool\s*ALL/i,  type:'fitness', sub:'aquatics',    label:'Multi-use Pool ALL' },
    { match: /^Lap?Pool*ALL*Lane\s/i,  type:'fitness', sub:'aquatics',    label:'Lap Pool All Lanes' },
  ];

  // Colors
  const PALETTE = {
    red:["bg-red-100","text-red-800","border-red-500"],
    orange:["bg-orange-100","text-orange-800","border-orange-500"],
    yellow:["bg-yellow-100","text-yellow-800","border-yellow-500"],
    green:["bg-green-100","text-green-800","border-green-500"],
    teal:["bg-teal-100","text-teal-800","border-teal-500"],
    cyan:["bg-cyan-100","text-cyan-800","border-cyan-500"],
    blue:["bg-blue-100","text-blue-800","border-blue-500"],
    purple:["bg-purple-100","text-purple-800","border-purple-500"],
    indigo:["bg-indigo-100","text-indigo-800","border-indigo-500"],
    pink:["bg-pink-100","text-pink-800","border-pink-500"],
    gray:["bg-gray-200","text-gray-800","border-gray-500"],
  };

  const ACTIVITY_COLORS = {
    'LAP SWIM':'blue','REC SWIM':'green',
    'BASKETBALL':'orange','VOLLEYBALL':'yellow','PICKLEBALL':'red',
    'DEFAULT':'gray'
  };
  const getColorForActivity = (name) => {
    const upper = String(name).toUpperCase();
    for (const [k,c] of Object.entries(ACTIVITY_COLORS)) if (upper.includes(k)) return c;
    return ACTIVITY_COLORS.DEFAULT;
  };

  /* =================== Model & Tabs =================== */
  let ALL_EVENTS = {};
  let CURRENT_WEEK = {};

  const PRIMARY = {
    dropin:  { label:'Drop-In',      subs:{ aquatics:'Aquatics', courtSports:'Court Sports', community:'Community' } },
    fitness: { label:'Group Fitness', subs:{ aquatics:'Aquatics', studio1:'Studio 1', studio2:'Studio 2', mac:'MAC Gym' } }
  };

  /* =================== Helpers =================== */
  function parseTime12h(t){
    const [time, apRaw='AM'] = String(t).trim().split(' ');
    const [hh, mm='0'] = time.split(':').map(Number);
    let h = hh % 12; if (apRaw.toUpperCase()==='PM') h += 12;
    return h + (+mm/60);
  }
  function parseDateFlexible(s){
    const x=String(s).trim();
    if (x.includes('/')){ const [mm,dd,yyyy]=x.split('/').map(Number); return new Date(yyyy,mm-1,dd); }
    if (x.includes('-')){ const [yyyy,mm,dd]=x.split('-').map(Number); return new Date(yyyy,mm-1,dd); }
    return new Date(x);
  }
  function stripRoomCode(loc){
    return String(loc||'').trim().replace(/^\uFEFF/, '').replace(/\s*\(\s*\d+\s*\)\s*$/,'').trim();
  }
  function classifyFromLocation(locationRaw){
    const simple = stripRoomCode(locationRaw);
    for (const rule of LOC_RULES){
      if (rule.match.test(simple)) return { type:rule.type, sub:rule.sub, label:rule.label };
    }
    return null; // unknown location → ignore for now
  }
  function ev(name, location, dayIndex, start, end, colorKey, type, sub){
    const [bg,text,border] = PALETTE[colorKey];
    return { id:`${name}-${dayIndex}-${start}`, name, location, dayIndex, start, end,
             color:{bg,text,border}, type, sub, date:null };
  }
  const eqGMCC = s => String(s||'').trim().toLowerCase() === GMCC.toLowerCase();

  /* =================== CSV =================== */
  function csvToRows(text){
    const rows = []; let row = []; let field = ''; let inQuotes = false;
    for (let i = 0; i < text.length; i++){
      const c = text[i];
      if (inQuotes){
        if (c === '"'){ if (text[i+1] === '"'){ field += '"'; i++; } else inQuotes = false; }
        else field += c;
      }else{
        if (c === '"') inQuotes = true;
        else if (c === ','){ row.push(field); field = ''; }
        else if (c === '\n'){ row.push(field); field = ''; rows.push(row); row = []; }
        else if (c !== '\r'){ field += c; }
      }
    }
    if (field.length > 0 || row.length > 0){ row.push(field); rows.push(row); }
    return rows.map(r => r.map(s => String(s).trim()));
  }

  async function loadCSVData(){
    const text = await fetch(CSV_URL, { cache:'no-store' }).then(r=>r.text());
    return parseCSV(text);
  }

  // Columns: 0 Facility, 1 Location, 2 (blank), 3 Date, 4 Start, 5 End, 6 Activity, 7 Building, 8 Reserver
  // (as of 12/31) Columns: 0 Facility, 1 Location, 2 (blank), 3 Date, 4 Start, 5 End, 6 Type, 7 Activity, 8 Instructor
  function parseCSV(csvText){
    const rows = csvToRows(csvText);
    const data = rows.slice(1);

    const store = {
      dropin:{ aquatics:{label:'Aquatics',events:[]}, courtSports:{label:'Court Sports',events:[]}, community:{label:'Community',events:[]} },
      fitness:{ aquatics:{label:'Aquatics',events:[]}, studio1:{label:'Studio 1',events:[]}, studio2:{label:'Studio 2',events:[]}, mac:{label:'MAC Gym',events:[]} }
    };

    for (const cols of data){
      if (!cols || cols.length < 9) continue;

      const facility = cols[0], locationRaw = cols[1], dateStr = cols[3],
            startTime = cols[4], endTime = cols[5], type = cols[6], activity = cols[7], 
            instructor = cols[8];

      // 1) Must be GMCC in col 0
      if (!eqGMCC(facility)) continue;

      // 2) Classify strictly by location
      const cls = classifyFromLocation(locationRaw);
      if (!cls) continue; // skip unknown locations for now

      // 4) Parse date/times; simplify location label for display
      const eventDate = parseDateFlexible(dateStr);
      if (isNaN(+eventDate)) continue;
      const startHour = parseTime12h(startTime);
      const endHour   = parseTime12h(endTime);
      const dayIndex  = (eventDate.getDay() + 6) % 7;

      const colorKey = getColorForActivity(activity);
      const e = ev(activity, cls.label, dayIndex, startHour, endHour, colorKey, cls.type, cls.sub);
      e.date = eventDate;
      store[cls.type][cls.sub].events.push(e);
    }
    return store;
  }

  /* =================== Week helpers =================== */
  const getMonday = d => { const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; };
  const addDays   = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const ymd       = d => d.toISOString().slice(0,10);
  const labelDate = d => d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
  function formatTime(hour){
    const h=Math.floor(hour), m=Math.round((hour-h)*60);
    const h12=(h%12)||12, ap=h<12?'AM':'PM', mm=m===0?'00':String(m).padStart(2,'0');
    return `${h12}:${mm} ${ap}`;
  }
  function filterWeek(all, weekStart){
    const weekEnd = addDays(weekStart,6);
    const out = {
      dropin:{ aquatics:{label:'Aquatics',events:[]}, courtSports:{label:'Court Sports',events:[]}, community:{label:'Community',events:[]} },
      fitness:{ aquatics:{label:'Aquatics',events:[]}, studio1:{label:'Studio 1',events:[]}, studio2:{label:'Studio 2',events:[]}, mac:{label:'MAC Gym',events:[]} }
    };
    for (const type of Object.keys(all)){
      for (const sub of Object.keys(all[type])){
        for (const e of all[type][sub].events){
          if (e.date >= weekStart && e.date <= weekEnd){
            const daysDiff = Math.floor((e.date - weekStart)/(1000*60*60*24));
            out[type][sub].events.push({...e, dayIndex:daysDiff});
          }
        }
      }
    }
    return out;
  }

  /* =================== State & refs =================== */
  const params = new URLSearchParams(location.search);
  const START_OF_WEEK = getMonday(new Date());
  let weekStart = params.get('w') ? new Date(params.get('w')) : START_OF_WEEK;
  if (isNaN(+weekStart)) weekStart = START_OF_WEEK;

  let currentType = (['dropin','fitness'].includes(params.get('type')) ? params.get('type') : 'dropin');
  let currentSub  = params.get('sub') || 'aquatics';

  const els = {
    primaryTabs: document.getElementById('primaryTabs'),
    tabs: document.getElementById('tabs'),
    gridHeader: document.getElementById('gridHeader'),
    gridBody: document.getElementById('gridBody'),
    list: document.getElementById('listView'),
    rangeLabel: document.getElementById('rangeLabel'),
    tzLabel: document.getElementById('tzLabel'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    todayBtn: document.getElementById('todayBtn'),
    scroller: document.getElementById('gridScroller'),
  };
  els.tzLabel.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;

  // Force arrows to render as text glyphs (not emoji)
  els.prevBtn.textContent = '\u25C0\uFE0E'; // ◀︎
  els.nextBtn.textContent = '\u25B6\uFE0E'; // ▶︎

  let dayOverlays=[];

  /* ===== popup ===== */
  let openpopupNodes = [];
  function closepopup(){ openpopupNodes.forEach(n => n.remove()); openpopupNodes = []; window.removeEventListener('keydown', escListener); }
  function escListener(e){ if (e.key === 'Escape') closepopup(); }
  function openpopup(eventObj, cardEl){
    closepopup();
    const backdrop = document.createElement('div'); backdrop.className = 'popup-backdrop'; backdrop.addEventListener('click', closepopup);
    const pop = document.createElement('div'); pop.className = 'popup';
    const minutes = Math.round((eventObj.end - eventObj.start) * 60);
    const titleColorClass = eventObj?.color?.text || 'text-gray-900';
    pop.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <h3 class="text-lg font-bold tracking-wide ${titleColorClass}">${eventObj.name}</h3>
      </div>
      <div class="mt-1 text-sm text-gray-700">${formatTime(eventObj.start)} – ${formatTime(eventObj.end)} (${minutes} min)</div>
      ${eventObj.location ? `<div class="text-sm text-gray-500">${eventObj.location}</div>` : ''}
      <div class="mt-2 text-xs text-gray-400">Click outside to close</div>`;
    const gridRect = els.gridBody.getBoundingClientRect();
    const cardRect = cardEl.getBoundingClientRect();
    const POP_W = 300, GAP = 12;
    const showRight = cardRect.right + GAP + POP_W < window.innerWidth;
    let left = showRight ? (cardRect.right - gridRect.left + GAP) : (cardRect.left  - gridRect.left - GAP - POP_W);
    left = Math.max(8, Math.min(left, gridRect.width - POP_W - 8));
    let top = Math.max(8, Math.min(cardRect.top - gridRect.top, gridRect.height - 16));
    pop.style.left = `${left}px`; pop.style.top  = `${top}px`;
    document.body.appendChild(backdrop); els.gridBody.appendChild(pop);
    openpopupNodes = [backdrop, pop]; window.addEventListener('keydown', escListener);
  }

  /* =================== Controls & render =================== */
  els.prevBtn.onclick = () => changeWeek(-7);
  els.nextBtn.onclick = () => changeWeek(+7);
  els.todayBtn.onclick = () => { weekStart=getMonday(new Date()); CURRENT_WEEK=filterWeek(ALL_EVENTS, weekStart); syncUrl(); render(); };

  function changeWeek(delta){ weekStart=addDays(weekStart,delta); CURRENT_WEEK=filterWeek(ALL_EVENTS, weekStart); syncUrl(); render(); }
  function syncUrl(){ const p=new URLSearchParams(); p.set('type',currentType); p.set('sub',currentSub); p.set('w',ymd(weekStart)); history.replaceState(null,'',`?${p.toString()}`); }

  function renderPrimary(){
    els.primaryTabs.innerHTML='';
    for (const type of Object.keys(PRIMARY)){
      const btn=document.createElement('button');
      btn.type='button'; btn.setAttribute('role','tab');
      btn.setAttribute('aria-pressed', String(type===currentType));
      btn.className='focus:outline-none';
      btn.textContent=PRIMARY[type].label;
      btn.onclick=()=>{
        currentType=type;
        if (!PRIMARY[currentType].subs[currentSub]) currentSub=Object.keys(PRIMARY[currentType].subs)[0];
        syncUrl(); render();
      };
      els.primaryTabs.appendChild(btn);
    }
  }

  function renderSubTabs(){
    els.tabs.innerHTML='';
    const subs=PRIMARY[currentType].subs;
    for (const key of Object.keys(subs)){
      const btn=document.createElement('button');
      btn.className='tab-btn py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300';
      btn.textContent=subs[key];
      if (key===currentSub) btn.classList.add('active');
      btn.onclick=()=>{ currentSub=key; document.querySelectorAll('#tabs .tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); syncUrl(); renderBody(); };
      els.tabs.appendChild(btn);
    }
  }

  function render(){ closepopup(); renderPrimary(); renderSubTabs(); renderHeader(); renderBody(); }

  function renderHeader(){
    els.gridHeader.innerHTML='';
    const timeCell=document.createElement('div');
    timeCell.className='p-2 border-r border-b border-gray-200 text-xs text-center font-semibold text-gray-500 flex items-center justify-center';
    timeCell.textContent='EDT';
    els.gridHeader.appendChild(timeCell);
    for (let i=0;i<7;i++){
      const d=addDays(weekStart,i);
      const h=document.createElement('div');
      h.className='p-2 border-b border-gray-200 text-center';
      const isToday=ymd(d)===ymd(new Date());
      h.innerHTML=`<p class="text-sm font-semibold ${isToday?'text-blue-600':'text-gray-600'}">${['MON','TUE','WED','THU','FRI','SAT','SUN'][i]}</p>
                   <p class="text-xs ${isToday?'font-semibold text-blue-600':'text-gray-700'}">${labelDate(d)}</p>`;
      els.gridHeader.appendChild(h);
    }
    const end=addDays(weekStart,6);
    els.rangeLabel.textContent=`${labelDate(weekStart)} – ${labelDate(end)}`;
  }

  function renderBody(){ renderGrid(); renderList(); }

  function renderGrid(){
    closepopup();
    const startHour=5, endHour=22;
    const rowH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
    els.gridBody.innerHTML=''; dayOverlays=[];
    for (let hour=startHour; hour<=endHour; hour++){
      const t=document.createElement('div');
      t.className='p-2 border-r border-gray-200 text-right text-xs text-gray-400 h-16 flex items-start justify-end -mt-2.5';
      if (hour<endHour){ const h12=(hour%12)||12; t.textContent=`${h12} ${hour<12?'AM':'PM'}`; }
      els.gridBody.appendChild(t);
      for (let day=0; day<7; day++){
        const cell=document.createElement('div');
        cell.className='border-r border-b border-gray-200 h-16 day-col';
        cell.dataset.day=day;
        els.gridBody.appendChild(cell);
      }
    }
    const firstRow=[...els.gridBody.querySelectorAll('.day-col')].slice(0,7);
    const totalH=(endHour-startHour)*rowH;
    for (let day=0; day<7; day++){
      const ref=firstRow[day];
      const left=ref.offsetLeft + ref.clientLeft;
      const width=ref.clientWidth;
      const ov=document.createElement('div');
      ov.style.position='absolute'; ov.style.zIndex='5'; ov.style.top='0';
      ov.style.left=`${left}px`; ov.style.width=`${width}px`; ov.style.height=`${totalH}px`; ov.style.pointerEvents='none';
      els.gridBody.appendChild(ov);
      dayOverlays[day]=ov;
    }

    const events=CURRENT_WEEK[currentType][currentSub].events;
    const byDay=Array.from({length:7},()=>[]);
    events.forEach(e=>byDay[e.dayIndex].push(e));
    for (let day=0; day<7; day++){
      const list=byDay[day].slice().sort((a,b)=> a.start===b.start ? b.end-a.end : a.start-b.start);
      placeEventsInDay(day, list);
    }
    positionNowLine(startHour,endHour);
  }

  function placeEventsInDay(dayIndex, dayEvents){
    if (!dayEvents.length) return;
    const startHour=5;
    const rowH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
    const groups=findOverlappingGroups(dayEvents);
    groups.forEach(group=>{
      const n=group.length;
      group.forEach((e,i)=>{
        const top=(e.start-startHour)*rowH;
        const height=(e.end-e.start)*rowH;
        const card=document.createElement('div');
        card.className=`event-card shadow-sm ${e.color.bg} ${e.color.text} ${e.color.border}`;
        card.style.top=`${top}px`; card.style.height=`${height}px`;
        if (n>1){
          const GAP=8;
          card.style.width=`calc((100% - ${(n-1)*GAP}px) / ${n})`;
          card.style.left =`calc(${i} * ( (100% - ${(n-1)*GAP}px) / ${n} + ${GAP}px))`;
          card.classList.add('narrow');
        } else {
          const PAD=8;
          card.style.width=`calc(100% - ${PAD*2}px)`; card.style.left=`${PAD}px`;
        }
        card.innerHTML = `
          <p class="event-line event-tight title">${e.name}</p>
          <p class="event-line event-tight subtext">${formatTime(e.start)} – ${formatTime(e.end)}</p>
          ${e.location ? `<p class="event-line event-tight location">${e.location}</p>` : ''}`;
        card.addEventListener('click', (ev) => { ev.stopPropagation(); openpopup(e, card); });
        const ov=dayOverlays[dayIndex]; if (ov) ov.appendChild(card);
      });
    });
  }

  function findOverlappingGroups(events){
    if (!events.length) return [];
    const sorted=[...events].sort((a,b)=> a.start-b.start);
    const groups=[]; let curr=[]; let maxEnd=-Infinity;
    for (const e of sorted){
      if (!curr.length || e.start < maxEnd){ curr.push(e); maxEnd=Math.max(maxEnd, e.end); }
      else { groups.push(curr); curr=[e]; maxEnd=e.end; }
    }
    if (curr.length) groups.push(curr);
    return groups;
  }

  function positionNowLine(startHour,endHour){
    document.querySelectorAll('.now-line').forEach(n=>n.remove());
    const now=new Date(); const dow=(now.getDay()+6)%7; const h=now.getHours(), m=now.getMinutes();
    if (h<startHour || h>=endHour) return;
    const ov=dayOverlays[dow]; if (!ov) return;
    const rowH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
    const top=((h-startHour)*60 + m) * (rowH/60);
    const line=document.createElement('div'); line.className='now-line'; line.style.left='0'; line.style.right='0'; line.style.top=`${top}px`;
    const dot=document.createElement('div'); dot.className='now-dot';
    line.appendChild(dot); ov.appendChild(line);
  }

  function renderList(){
    els.list.innerHTML='';
    const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const events=CURRENT_WEEK[currentType][currentSub].events;
    const byDay=Array.from({length:7},()=>[]);
    events.forEach(e=>byDay[e.dayIndex].push(e));
    for (let i=0;i<7;i++){
      const d=addDays(weekStart,i);
      const header=document.createElement('div');
      const isToday=ymd(d)===ymd(new Date());
      header.className='pt-2 pb-2 border-b';
      header.innerHTML=`<h2 class="text-lg font-bold ${isToday?'text-blue-700':''}">${days[i]}</h2><div class="text-xs text-gray-500">${labelDate(d)}</div>`;
      els.list.appendChild(header);
      if (!byDay[i].length){
        const none=document.createElement('div'); none.className='text-sm text-gray-400 pt-2'; none.textContent='No events'; els.list.appendChild(none);
      }else{
        byDay[i].sort((a,b)=>a.start-b.start).forEach(e=>{
          const item=document.createElement('div');
          item.className=`mt-2 p-3 rounded-lg ${e.color.bg} ${e.color.text}`;
          item.innerHTML=`<p class="font-semibold">${e.name}</p>
                          <p class="text-sm opacity-90">${formatTime(e.start)} – ${formatTime(e.end)}</p>
                          ${e.location?`<p class="text-sm opacity-75">${e.location}</p>`:''}`;
          els.list.appendChild(item);
        });
      }
    }
  }

  let resizeTimeout;
  window.addEventListener('resize', ()=>{ clearTimeout(resizeTimeout); resizeTimeout=setTimeout(()=>renderGrid(),100); });

  /* =================== Boot =================== */
  async function initialize(){
    ALL_EVENTS = await loadCSVData();
    CURRENT_WEEK = filterWeek(ALL_EVENTS, weekStart);
    if (!PRIMARY[currentType].subs[currentSub]) currentSub = Object.keys(PRIMARY[currentType].subs)[0];
    render(); syncUrl();
  }
  initialize();
  </script>
</body>
</html>